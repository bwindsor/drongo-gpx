import xml.etree.ElementTree as ET
import re
import json
from typing import Match, Tuple
from multipart_decoder import MultipartDecoder


def handler(event, context):
    print(json.dumps(event))

    content_type = event['headers']['content-type']
    content: str = event['body']
    multipart_data = MultipartDecoder(content.encode('utf8'), content_type)

    control_code = None
    ppen_xml_original = None
    ppen_xml_shifted = None
    for part in multipart_data.parts:
        for h in part.headers:
            for h_part in h:
                if b'name="controlcode"' in h_part:
                    control_code = part.text
                if b'name="originalfile"' in h_part:
                    ppen_xml_original = part.text
                if b'name="shiftedfile"' in h_part:
                    ppen_xml_shifted = part.text

    # parameter: controlcode
    if control_code is None:
        return make_bad_request_response("Missing required parameter controlcode")

    # ppen_xml
    if ppen_xml_original is None:
        return make_bad_request_response("Missing file upload for original file")
    if ppen_xml_shifted is None:
        return make_bad_request_response("Missing file upload for shifted file")

    shifted_ppen = shift_ppen_from_files(ppen_xml_original, ppen_xml_shifted, control_code)

    return {
        'statusCode': 200,
        'body': shifted_ppen,
        'headers': {
            'Content-Type': 'application/xml',
            'Content-Disposition': "attachment; filename=what-a-pengalucious-course.ppen"
        }
    }


def shift_ppen_from_files(xml_original: str, xml_shifted: str, control_code: str) -> str:
    x_shift, y_shift = get_x_y_shift(xml_original, xml_shifted, control_code)
    return shift_ppen(xml_original, x_shift, y_shift)


def get_x_y_shift(original: str, shifted: str, control_code: str) -> Tuple[float, float]:
    x_original, y_original = get_control_location(original, control_code)
    x_shifted, y_shifted = get_control_location(shifted, control_code)
    return x_shifted - x_original, y_shifted - y_original


def get_control_location(ppen_xml: str, control_code: str) -> Tuple[float, float]:
    start_idx = ppen_xml.find('<')
    root = ET.fromstring(ppen_xml[start_idx:])

    controls = [c for c in root if c.tag == 'control']
    for c in controls:
        codes = [p.text for p in c if p.tag == 'code']
        if len(codes) == 1:
            if codes[0] == control_code:
                location = [p.attrib for p in c if p.tag == 'location'][0]
                return float(location['x']), float(location['y'])
    raise Exception(f"Control {control_code} not found in file")


def make_bad_request_response(message: str) -> dict:
    return {
        'statusCode': 400,
        'body': json.dumps({"message": message}),
        'headers': {
            'Content-Type': 'application/json'
        }
    }


def shift_ppen(ppen_xml: str, x_shift: float, y_shift: float) -> str:
    p = re.compile(r'<location x="(-?[\d\.]+)" y="(-?[\d\.]+)" />')
    shifted_string, num_replacements = p.subn(lambda m: shift_coords(m, x_shift, y_shift), ppen_xml)

    p = re.compile(r'left="(-?[\d\.]+)" top="(-?[\d\.]+)" right="(-?[\d\.]+)" bottom="(-?[\d\.]+)"')
    shifted_string, num_replacements = p.subn(lambda m: shift_print_area(m, x_shift, y_shift), shifted_string)

    return shifted_string


def shift_coords(match: Match, x_shift: float, y_shift: float):
    x, y = [float(x) for x in match.groups()]
    return f'<location x="{x + x_shift:.6f}" y="{y + y_shift:.6f}" />'


def shift_print_area(match: Match, x_shift: float, y_shift: float):
    left, top, right, bottom = [float(x) for x in match.groups()]
    return f'left="{left + x_shift:.6f}" top="{top + y_shift:.6f}" right="{right + x_shift:.6f}" bottom="{bottom + y_shift:.6f}"'


if __name__ == "__main__":
    file_original = "example_inputs/example_ppen.ppen"
    file_shifted = "example_inputs/example_ppen_31_shifted.ppen"

    with open(file_original, 'r') as f:
        file_as_string = f.read()
    with open(file_shifted, 'r') as f:
        file_as_string_2 = f.read()

    print(file_as_string.encode('utf8'))
    result = shift_ppen_from_files(file_as_string, file_as_string_2, '31')
    print(result.encode('utf8'))
    with open('output.ppen', 'w') as f:
        f.write(result)

    event = {
        'headers': {
            'content-type': "multipart/form-data; boundary=----WebKitFormBoundaryW0wKf7e6Tkruhksr"
        },
        'body': "------WebKitFormBoundaryW0wKf7e6Tkruhksr\r\nContent-Disposition: form-data; name=\"controlcode\"\r\n\r\n45\r\n------WebKitFormBoundaryW0wKf7e6Tkruhksr\r\nContent-Disposition: form-data; name=\"originalfile\"; filename=\"Quad Match 2020.ppen\"\r\nContent-Type: application/octet-stream\r\n\r\n﻿<course-scribe-event>\r\n  <event id=\"1\">\r\n    <title>Quad Match 2020</title>\r\n    <map kind=\"OCAD\" scale=\"10000\" ignore-missing-fonts=\"false\" absolute-path=\"C:\\Users\\BenJW\\Dropbox\\BenWindsor\\Documents\\Interests\\Orienteering\\Events\\2020-05 Epping Quad Match\\EE Nov 2019 ISOM OCAD 2019 v4.ocd\">EE Nov 2019 ISOM OCAD 2019 v4.ocd</map>\r\n    <standards map=\"2017\" description=\"2018\" />\r\n    <all-controls print-scale=\"10000\" description-kind=\"symbols\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <numbering start=\"31\" disallow-invertible=\"false\" />\r\n    <punch-card rows=\"3\" columns=\"8\" left-to-right=\"true\" top-to-bottom=\"false\" />\r\n    <course-appearance scale-sizes=\"RelativeTo15000\" scale-sizes-circle-gaps=\"true\" auto-leg-gap-size=\"3.5\" blend-purple=\"true\" />\r\n    <descriptions lang=\"en-GB\" color=\"black\" />\r\n    <ocad overprint-colors=\"false\" />\r\n  </event>\r\n  <control id=\"1\" kind=\"start\">\r\n    <location x=\"85.63277\" y=\"147.492142\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n  </control>\r\n  <control id=\"2\" kind=\"finish\">\r\n    <location x=\"88.31481\" y=\"153.8992\" />\r\n    <description box=\"all\" iof-2004-ref=\"14.3\" />\r\n  </control>\r\n  <control id=\"3\" kind=\"normal\">\r\n    <code>31</code>\r\n    <location x=\"81.64763\" y=\"139.239853\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.2\" />\r\n  </control>\r\n  <control id=\"10\" kind=\"normal\">\r\n    <code>32</code>\r\n    <location x=\"72.2580261\" y=\"100.883858\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"43\" kind=\"normal\">\r\n    <code>33</code>\r\n    <location x=\"69.94294\" y=\"55.38756\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.1\" />\r\n  </control>\r\n  <control id=\"12\" kind=\"normal\">\r\n    <code>34</code>\r\n    <location x=\"42.7933121\" y=\"88.06778\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n  </control>\r\n  <control id=\"13\" kind=\"normal\">\r\n    <code>35</code>\r\n    <location x=\"52.6457634\" y=\"106.277084\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"E\" iof-2004-ref=\"3.6\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.1\" />\r\n  </control>\r\n  <control id=\"14\" kind=\"normal\">\r\n    <code>36</code>\r\n    <location x=\"64.98082\" y=\"129.350067\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"11.7\" />\r\n  </control>\r\n  <control id=\"15\" kind=\"normal\">\r\n    <code>37</code>\r\n    <location x=\"71.8275\" y=\"139.9188\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"E\" iof-2004-ref=\"3.6\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.1\" />\r\n  </control>\r\n  <control id=\"42\" kind=\"normal\">\r\n    <code>38</code>\r\n    <location x=\"80.2943\" y=\"148.285324\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n  </control>\r\n  <control id=\"17\" kind=\"normal\">\r\n    <code>39</code>\r\n    <location x=\"34.5140839\" y=\"91.05244\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.2NE\" />\r\n  </control>\r\n  <control id=\"23\" kind=\"normal\">\r\n    <code>40</code>\r\n    <location x=\"91.96569\" y=\"138.6052\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.1S\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.13\" />\r\n  </control>\r\n  <control id=\"24\" kind=\"normal\">\r\n    <code>41</code>\r\n    <location x=\"110.713646\" y=\"126.764252\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"25\" kind=\"normal\">\r\n    <code>42</code>\r\n    <location x=\"78.51836\" y=\"84.8133545\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1SE\" />\r\n  </control>\r\n  <control id=\"26\" kind=\"normal\">\r\n    <code>43</code>\r\n    <location x=\"84.85482\" y=\"77.8665543\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1SE\" />\r\n  </control>\r\n  <control id=\"27\" kind=\"normal\">\r\n    <code>44</code>\r\n    <location x=\"62.1889343\" y=\"51.8967438\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"28\" kind=\"normal\">\r\n    <code>45</code>\r\n    <location x=\"39.7934532\" y=\"49.7193756\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.2E\" />\r\n  </control>\r\n  <control id=\"29\" kind=\"normal\">\r\n    <code>46</code>\r\n    <location x=\"31.3751926\" y=\"78.75542\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.1S\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.10\" />\r\n  </control>\r\n  <control id=\"30\" kind=\"normal\">\r\n    <code>47</code>\r\n    <location x=\"20.9663963\" y=\"132.004959\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.5\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.13\" />\r\n  </control>\r\n  <control id=\"31\" kind=\"normal\">\r\n    <code>48</code>\r\n    <location x=\"19.7433376\" y=\"144.740021\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.12\" />\r\n  </control>\r\n  <control id=\"32\" kind=\"normal\">\r\n    <code>49</code>\r\n    <location x=\"34.4861946\" y=\"119.050323\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.5\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"34\" kind=\"normal\">\r\n    <code>50</code>\r\n    <location x=\"50.3374939\" y=\"139.197769\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"35\" kind=\"normal\">\r\n    <code>51</code>\r\n    <location x=\"124.112724\" y=\"135.494186\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"36\" kind=\"normal\">\r\n    <code>52</code>\r\n    <location x=\"110.187263\" y=\"154.594147\" />\r\n    <description box=\"D\" iof-2004-ref=\"3.7\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1N\" />\r\n  </control>\r\n  <control id=\"37\" kind=\"normal\">\r\n    <code>53</code>\r\n    <location x=\"90.23759\" y=\"127.063721\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.13\" />\r\n  </control>\r\n  <control id=\"38\" kind=\"normal\">\r\n    <code>54</code>\r\n    <location x=\"102.013763\" y=\"101.303635\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"39\" kind=\"normal\">\r\n    <code>55</code>\r\n    <location x=\"39.1706238\" y=\"109.763283\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.2SW\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"40\" kind=\"normal\">\r\n    <code>56</code>\r\n    <location x=\"30.0110168\" y=\"66.014534\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.6\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.8N\" />\r\n  </control>\r\n  <control id=\"41\" kind=\"normal\">\r\n    <code>57</code>\r\n    <location x=\"67.74276\" y=\"84.97686\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.5\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1N\" />\r\n  </control>\r\n  <control id=\"44\" kind=\"normal\">\r\n    <code>58</code>\r\n    <location x=\"60.1512337\" y=\"41.4735374\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"11.7\" />\r\n  </control>\r\n  <control id=\"45\" kind=\"normal\">\r\n    <code>59</code>\r\n    <location x=\"45.58684\" y=\"65.6313553\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"11.7\" />\r\n  </control>\r\n  <course id=\"1\" kind=\"normal\" order=\"1\">\r\n    <name>Yellow</name>\r\n    <labels label-kind=\"sequence\" />\r\n    <first course-control=\"1\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <options print-scale=\"10000\" description-kind=\"symbols\" />\r\n  </course>\r\n  <course id=\"2\" kind=\"normal\" order=\"2\">\r\n    <name>Green</name>\r\n    <labels label-kind=\"sequence\" />\r\n    <first course-control=\"3\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <options print-scale=\"10000\" description-kind=\"symbols\" />\r\n  </course>\r\n  <course id=\"4\" kind=\"normal\" order=\"3\">\r\n    <name>Blue</name>\r\n    <labels label-kind=\"sequence\" />\r\n    <first course-control=\"45\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <options print-scale=\"10000\" description-kind=\"symbols\" />\r\n  </course>\r\n  <course-control id=\"1\" control=\"1\">\r\n    <next course-control=\"7\" />\r\n  </course-control>\r\n  <course-control id=\"2\" control=\"2\" />\r\n  <course-control id=\"3\" control=\"1\">\r\n    <next course-control=\"28\" />\r\n  </course-control>\r\n  <course-control id=\"4\" control=\"2\" />\r\n  <course-control id=\"7\" control=\"3\">\r\n    <next course-control=\"14\" />\r\n  </course-control>\r\n  <course-control id=\"14\" control=\"10\">\r\n    <next course-control=\"68\" />\r\n  </course-control>\r\n  <course-control id=\"68\" control=\"43\">\r\n    <next course-control=\"69\" />\r\n  </course-control>\r\n  <course-control id=\"16\" control=\"12\">\r\n    <next course-control=\"17\" />\r\n  </course-control>\r\n  <course-control id=\"17\" control=\"13\">\r\n    <next course-control=\"18\" />\r\n  </course-control>\r\n  <course-control id=\"18\" control=\"14\">\r\n    <next course-control=\"19\" />\r\n  </course-control>\r\n  <course-control id=\"19\" control=\"15\">\r\n    <next course-control=\"2\" />\r\n  </course-control>\r\n  <course-control id=\"70\" control=\"45\">\r\n    <next course-control=\"16\" />\r\n  </course-control>\r\n  <course-control id=\"69\" control=\"44\">\r\n    <next course-control=\"70\" />\r\n  </course-control>\r\n  <course-control id=\"28\" control=\"23\">\r\n    <next course-control=\"29\" />\r\n  </course-control>\r\n  <course-control id=\"29\" control=\"24\">\r\n    <next course-control=\"42\" />\r\n  </course-control>\r\n  <course-control id=\"44\" control=\"25\">\r\n    <next course-control=\"32\" />\r\n  </course-control>\r\n  <course-control id=\"31\" control=\"26\">\r\n    <next course-control=\"44\" />\r\n  </course-control>\r\n  <course-control id=\"32\" control=\"27\">\r\n    <next course-control=\"33\" />\r\n  </course-control>\r\n  <course-control id=\"33\" control=\"28\">\r\n    <next course-control=\"34\" />\r\n  </course-control>\r\n  <course-control id=\"34\" control=\"29\">\r\n    <next course-control=\"35\" />\r\n  </course-control>\r\n  <course-control id=\"35\" control=\"17\">\r\n    <next course-control=\"36\" />\r\n  </course-control>\r\n  <course-control id=\"36\" control=\"30\">\r\n    <next course-control=\"37\" />\r\n  </course-control>\r\n  <course-control id=\"37\" control=\"31\">\r\n    <next course-control=\"38\" />\r\n  </course-control>\r\n  <course-control id=\"38\" control=\"32\">\r\n    <next course-control=\"41\" />\r\n  </course-control>\r\n  <course-control id=\"41\" control=\"34\">\r\n    <next course-control=\"40\" />\r\n  </course-control>\r\n  <course-control id=\"40\" control=\"15\">\r\n    <next course-control=\"4\" />\r\n  </course-control>\r\n  <course-control id=\"42\" control=\"35\">\r\n    <next course-control=\"43\" />\r\n  </course-control>\r\n  <course-control id=\"43\" control=\"36\">\r\n    <next course-control=\"31\" />\r\n  </course-control>\r\n  <course-control id=\"45\" control=\"1\">\r\n    <next course-control=\"46\" />\r\n  </course-control>\r\n  <course-control id=\"46\" control=\"23\">\r\n    <next course-control=\"47\" />\r\n  </course-control>\r\n  <course-control id=\"47\" control=\"24\">\r\n    <next course-control=\"48\" />\r\n  </course-control>\r\n  <course-control id=\"48\" control=\"35\">\r\n    <next course-control=\"49\" />\r\n  </course-control>\r\n  <course-control id=\"49\" control=\"36\">\r\n    <next course-control=\"50\" />\r\n  </course-control>\r\n  <course-control id=\"50\" control=\"26\">\r\n    <next course-control=\"51\" />\r\n  </course-control>\r\n  <course-control id=\"51\" control=\"25\">\r\n    <next course-control=\"65\" />\r\n  </course-control>\r\n  <course-control id=\"66\" control=\"27\">\r\n    <next course-control=\"67\" />\r\n  </course-control>\r\n  <course-control id=\"53\" control=\"28\">\r\n    <next course-control=\"66\" />\r\n  </course-control>\r\n  <course-control id=\"54\" control=\"29\">\r\n    <next course-control=\"55\" />\r\n  </course-control>\r\n  <course-control id=\"55\" control=\"17\">\r\n    <next course-control=\"56\" />\r\n  </course-control>\r\n  <course-control id=\"56\" control=\"30\">\r\n    <next course-control=\"57\" />\r\n  </course-control>\r\n  <course-control id=\"57\" control=\"31\">\r\n    <next course-control=\"58\" />\r\n  </course-control>\r\n  <course-control id=\"58\" control=\"32\">\r\n    <next course-control=\"62\" />\r\n  </course-control>\r\n  <course-control id=\"59\" control=\"34\">\r\n    <next course-control=\"60\" />\r\n  </course-control>\r\n  <course-control id=\"60\" control=\"15\">\r\n    <next course-control=\"61\" />\r\n  </course-control>\r\n  <course-control id=\"61\" control=\"2\" />\r\n  <course-control id=\"62\" control=\"37\">\r\n    <next course-control=\"63\" />\r\n  </course-control>\r\n  <course-control id=\"63\" control=\"38\">\r\n    <next course-control=\"64\" />\r\n  </course-control>\r\n  <course-control id=\"64\" control=\"39\">\r\n    <next course-control=\"59\" />\r\n  </course-control>\r\n  <course-control id=\"65\" control=\"40\">\r\n    <next course-control=\"53\" />\r\n  </course-control>\r\n  <course-control id=\"67\" control=\"41\">\r\n    <next course-control=\"54\" />\r\n  </course-control>\r\n  <special-object id=\"1\" kind=\"descriptions\">\r\n    <appearance columns=\"2\" />\r\n    <location x=\"-1.00035858\" y=\"2.0887146\" />\r\n    <location x=\"5.084303\" y=\"2.0887146\" />\r\n    <courses all=\"true\" />\r\n  </special-object>\r\n  <special-object id=\"2\" kind=\"text\">\r\n    <text>$(CourseName)</text>\r\n    <font name=\"Roboto\" bold=\"true\" italic=\"false\" />\r\n    <appearance color=\"purple\" />\r\n    <location x=\"102.2344\" y=\"2.537117\" />\r\n    <location x=\"157.146332\" y=\"-20.954422\" />\r\n    <courses all=\"true\" />\r\n  </special-object>\r\n  <special-object id=\"3\" kind=\"text\">\r\n    <text>Courses close 20:00</text>\r\n    <font name=\"Roboto\" bold=\"true\" italic=\"false\" />\r\n    <appearance color=\"purple\" />\r\n    <location x=\"102.5395\" y=\"-17.9026871\" />\r\n    <location x=\"157.146332\" y=\"-26.14064\" />\r\n    <courses all=\"true\" />\r\n  </special-object>\r\n</course-scribe-event>\r\n------WebKitFormBoundaryW0wKf7e6Tkruhksr\r\nContent-Disposition: form-data; name=\"shiftedfile\"; filename=\"Quad Match 2020 Shifted.ppen\"\r\nContent-Type: application/octet-stream\r\n\r\n﻿<course-scribe-event>\r\n  <event id=\"1\">\r\n    <title>Quad Match 2020</title>\r\n    <map kind=\"OCAD\" scale=\"10000\" ignore-missing-fonts=\"false\" absolute-path=\"C:\\Users\\BenJW\\Dropbox\\BenWindsor\\Documents\\Interests\\Orienteering\\Events\\2020-05 Epping Quad Match\\EE Nov 2019 ISOM OCAD 2019 v4.ocd\">EE Nov 2019 ISOM OCAD 2019 v4.ocd</map>\r\n    <standards map=\"2017\" description=\"2018\" />\r\n    <all-controls print-scale=\"10000\" description-kind=\"symbols\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <numbering start=\"31\" disallow-invertible=\"false\" />\r\n    <punch-card rows=\"3\" columns=\"8\" left-to-right=\"true\" top-to-bottom=\"false\" />\r\n    <course-appearance scale-sizes=\"RelativeTo15000\" scale-sizes-circle-gaps=\"true\" auto-leg-gap-size=\"3.5\" blend-purple=\"true\" />\r\n    <descriptions lang=\"en-GB\" color=\"black\" />\r\n    <ocad overprint-colors=\"false\" />\r\n  </event>\r\n  <control id=\"1\" kind=\"start\">\r\n    <location x=\"85.63277\" y=\"147.492142\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n  </control>\r\n  <control id=\"2\" kind=\"finish\">\r\n    <location x=\"88.31481\" y=\"153.8992\" />\r\n    <description box=\"all\" iof-2004-ref=\"14.3\" />\r\n  </control>\r\n  <control id=\"3\" kind=\"normal\">\r\n    <code>31</code>\r\n    <location x=\"81.64763\" y=\"139.239853\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.2\" />\r\n  </control>\r\n  <control id=\"10\" kind=\"normal\">\r\n    <code>32</code>\r\n    <location x=\"72.2580261\" y=\"100.883858\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"43\" kind=\"normal\">\r\n    <code>33</code>\r\n    <location x=\"69.94294\" y=\"55.38756\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.1\" />\r\n  </control>\r\n  <control id=\"12\" kind=\"normal\">\r\n    <code>34</code>\r\n    <location x=\"42.7933121\" y=\"88.06778\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n  </control>\r\n  <control id=\"13\" kind=\"normal\">\r\n    <code>35</code>\r\n    <location x=\"52.6457634\" y=\"106.277084\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"E\" iof-2004-ref=\"3.6\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.1\" />\r\n  </control>\r\n  <control id=\"14\" kind=\"normal\">\r\n    <code>36</code>\r\n    <location x=\"64.98082\" y=\"129.350067\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"11.7\" />\r\n  </control>\r\n  <control id=\"15\" kind=\"normal\">\r\n    <code>37</code>\r\n    <location x=\"71.8275\" y=\"139.9188\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"E\" iof-2004-ref=\"3.6\" />\r\n    <description box=\"F\" iof-2004-ref=\"10.1\" />\r\n  </control>\r\n  <control id=\"42\" kind=\"normal\">\r\n    <code>38</code>\r\n    <location x=\"80.2943\" y=\"148.285324\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n  </control>\r\n  <control id=\"17\" kind=\"normal\">\r\n    <code>39</code>\r\n    <location x=\"34.5140839\" y=\"91.05244\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.2NE\" />\r\n  </control>\r\n  <control id=\"23\" kind=\"normal\">\r\n    <code>40</code>\r\n    <location x=\"91.96569\" y=\"138.6052\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.1S\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.13\" />\r\n  </control>\r\n  <control id=\"24\" kind=\"normal\">\r\n    <code>41</code>\r\n    <location x=\"110.713646\" y=\"126.764252\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"25\" kind=\"normal\">\r\n    <code>42</code>\r\n    <location x=\"78.51836\" y=\"84.8133545\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1SE\" />\r\n  </control>\r\n  <control id=\"26\" kind=\"normal\">\r\n    <code>43</code>\r\n    <location x=\"84.85482\" y=\"77.8665543\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1SE\" />\r\n  </control>\r\n  <control id=\"27\" kind=\"normal\">\r\n    <code>44</code>\r\n    <location x=\"62.1889343\" y=\"51.8967438\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"28\" kind=\"normal\">\r\n    <code>45</code>\r\n    <location x=\"8.112461\" y=\"43.03646\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.4\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.2E\" />\r\n  </control>\r\n  <control id=\"29\" kind=\"normal\">\r\n    <code>46</code>\r\n    <location x=\"31.3751926\" y=\"78.75542\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.1S\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.10\" />\r\n  </control>\r\n  <control id=\"30\" kind=\"normal\">\r\n    <code>47</code>\r\n    <location x=\"20.9663963\" y=\"132.004959\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.5\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.13\" />\r\n  </control>\r\n  <control id=\"31\" kind=\"normal\">\r\n    <code>48</code>\r\n    <location x=\"19.7433376\" y=\"144.740021\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.12\" />\r\n  </control>\r\n  <control id=\"32\" kind=\"normal\">\r\n    <code>49</code>\r\n    <location x=\"34.4861946\" y=\"119.050323\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.5\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.10\" />\r\n  </control>\r\n  <control id=\"34\" kind=\"normal\">\r\n    <code>50</code>\r\n    <location x=\"50.3374939\" y=\"139.197769\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"35\" kind=\"normal\">\r\n    <code>51</code>\r\n    <location x=\"124.112724\" y=\"135.494186\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"36\" kind=\"normal\">\r\n    <code>52</code>\r\n    <location x=\"110.187263\" y=\"154.594147\" />\r\n    <description box=\"D\" iof-2004-ref=\"3.7\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1N\" />\r\n  </control>\r\n  <control id=\"37\" kind=\"normal\">\r\n    <code>53</code>\r\n    <location x=\"90.23759\" y=\"127.063721\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.13\" />\r\n  </control>\r\n  <control id=\"38\" kind=\"normal\">\r\n    <code>54</code>\r\n    <location x=\"102.013763\" y=\"101.303635\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"39\" kind=\"normal\">\r\n    <code>55</code>\r\n    <location x=\"39.1706238\" y=\"109.763283\" />\r\n    <description box=\"C\" iof-2004-ref=\"0.2SW\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.3\" />\r\n  </control>\r\n  <control id=\"40\" kind=\"normal\">\r\n    <code>56</code>\r\n    <location x=\"30.0110168\" y=\"66.014534\" />\r\n    <description box=\"D\" iof-2004-ref=\"1.6\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.8N\" />\r\n  </control>\r\n  <control id=\"41\" kind=\"normal\">\r\n    <code>57</code>\r\n    <location x=\"67.74276\" y=\"84.97686\" />\r\n    <description box=\"D\" iof-2004-ref=\"4.5\" />\r\n    <description box=\"G\" iof-2004-ref=\"11.1N\" />\r\n  </control>\r\n  <control id=\"44\" kind=\"normal\">\r\n    <code>58</code>\r\n    <location x=\"60.1512337\" y=\"41.4735374\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"11.7\" />\r\n  </control>\r\n  <control id=\"45\" kind=\"normal\">\r\n    <code>59</code>\r\n    <location x=\"45.58684\" y=\"65.6313553\" />\r\n    <description box=\"D\" iof-2004-ref=\"5.2\" />\r\n    <description box=\"F\" iof-2004-ref=\"11.7\" />\r\n  </control>\r\n  <course id=\"1\" kind=\"normal\" order=\"1\">\r\n    <name>Yellow</name>\r\n    <labels label-kind=\"sequence\" />\r\n    <first course-control=\"1\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <options print-scale=\"10000\" description-kind=\"symbols\" />\r\n  </course>\r\n  <course id=\"2\" kind=\"normal\" order=\"2\">\r\n    <name>Green</name>\r\n    <labels label-kind=\"sequence\" />\r\n    <first course-control=\"3\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <options print-scale=\"10000\" description-kind=\"symbols\" />\r\n  </course>\r\n  <course id=\"4\" kind=\"normal\" order=\"3\">\r\n    <name>Blue</name>\r\n    <labels label-kind=\"sequence\" />\r\n    <first course-control=\"45\" />\r\n    <print-area automatic=\"false\" restrict-to-page-size=\"true\" left=\"-74.15886\" top=\"195.8901\" right=\"127.771149\" bottom=\"-92.9079\" page-width=\"827\" page-height=\"1169\" page-margins=\"16\" page-landscape=\"false\" />\r\n    <options print-scale=\"10000\" description-kind=\"symbols\" />\r\n  </course>\r\n  <course-control id=\"1\" control=\"1\">\r\n    <next course-control=\"7\" />\r\n  </course-control>\r\n  <course-control id=\"2\" control=\"2\" />\r\n  <course-control id=\"3\" control=\"1\">\r\n    <next course-control=\"28\" />\r\n  </course-control>\r\n  <course-control id=\"4\" control=\"2\" />\r\n  <course-control id=\"7\" control=\"3\">\r\n    <next course-control=\"14\" />\r\n  </course-control>\r\n  <course-control id=\"14\" control=\"10\">\r\n    <next course-control=\"68\" />\r\n  </course-control>\r\n  <course-control id=\"68\" control=\"43\">\r\n    <next course-control=\"69\" />\r\n  </course-control>\r\n  <course-control id=\"16\" control=\"12\">\r\n    <next course-control=\"17\" />\r\n  </course-control>\r\n  <course-control id=\"17\" control=\"13\">\r\n    <next course-control=\"18\" />\r\n  </course-control>\r\n  <course-control id=\"18\" control=\"14\">\r\n    <next course-control=\"19\" />\r\n  </course-control>\r\n  <course-control id=\"19\" control=\"15\">\r\n    <next course-control=\"2\" />\r\n  </course-control>\r\n  <course-control id=\"70\" control=\"45\">\r\n    <next course-control=\"16\" />\r\n  </course-control>\r\n  <course-control id=\"69\" control=\"44\">\r\n    <next course-control=\"70\" />\r\n  </course-control>\r\n  <course-control id=\"28\" control=\"23\">\r\n    <next course-control=\"29\" />\r\n  </course-control>\r\n  <course-control id=\"29\" control=\"24\">\r\n    <next course-control=\"42\" />\r\n  </course-control>\r\n  <course-control id=\"44\" control=\"25\">\r\n    <next course-control=\"32\" />\r\n  </course-control>\r\n  <course-control id=\"31\" control=\"26\">\r\n    <next course-control=\"44\" />\r\n  </course-control>\r\n  <course-control id=\"32\" control=\"27\">\r\n    <next course-control=\"33\" />\r\n  </course-control>\r\n  <course-control id=\"33\" control=\"28\">\r\n    <next course-control=\"34\" />\r\n  </course-control>\r\n  <course-control id=\"34\" control=\"29\">\r\n    <next course-control=\"35\" />\r\n  </course-control>\r\n  <course-control id=\"35\" control=\"17\">\r\n    <next course-control=\"36\" />\r\n  </course-control>\r\n  <course-control id=\"36\" control=\"30\">\r\n    <next course-control=\"37\" />\r\n  </course-control>\r\n  <course-control id=\"37\" control=\"31\">\r\n    <next course-control=\"38\" />\r\n  </course-control>\r\n  <course-control id=\"38\" control=\"32\">\r\n    <next course-control=\"41\" />\r\n  </course-control>\r\n  <course-control id=\"41\" control=\"34\">\r\n    <next course-control=\"40\" />\r\n  </course-control>\r\n  <course-control id=\"40\" control=\"15\">\r\n    <next course-control=\"4\" />\r\n  </course-control>\r\n  <course-control id=\"42\" control=\"35\">\r\n    <next course-control=\"43\" />\r\n  </course-control>\r\n  <course-control id=\"43\" control=\"36\">\r\n    <next course-control=\"31\" />\r\n  </course-control>\r\n  <course-control id=\"45\" control=\"1\">\r\n    <next course-control=\"46\" />\r\n  </course-control>\r\n  <course-control id=\"46\" control=\"23\">\r\n    <next course-control=\"47\" />\r\n  </course-control>\r\n  <course-control id=\"47\" control=\"24\">\r\n    <next course-control=\"48\" />\r\n  </course-control>\r\n  <course-control id=\"48\" control=\"35\">\r\n    <next course-control=\"49\" />\r\n  </course-control>\r\n  <course-control id=\"49\" control=\"36\">\r\n    <next course-control=\"50\" />\r\n  </course-control>\r\n  <course-control id=\"50\" control=\"26\">\r\n    <next course-control=\"51\" />\r\n  </course-control>\r\n  <course-control id=\"51\" control=\"25\">\r\n    <next course-control=\"65\" />\r\n  </course-control>\r\n  <course-control id=\"66\" control=\"27\">\r\n    <next course-control=\"67\" />\r\n  </course-control>\r\n  <course-control id=\"53\" control=\"28\">\r\n    <next course-control=\"66\" />\r\n  </course-control>\r\n  <course-control id=\"54\" control=\"29\">\r\n    <next course-control=\"55\" />\r\n  </course-control>\r\n  <course-control id=\"55\" control=\"17\">\r\n    <next course-control=\"56\" />\r\n  </course-control>\r\n  <course-control id=\"56\" control=\"30\">\r\n    <next course-control=\"57\" />\r\n  </course-control>\r\n  <course-control id=\"57\" control=\"31\">\r\n    <next course-control=\"58\" />\r\n  </course-control>\r\n  <course-control id=\"58\" control=\"32\">\r\n    <next course-control=\"62\" />\r\n  </course-control>\r\n  <course-control id=\"59\" control=\"34\">\r\n    <next course-control=\"60\" />\r\n  </course-control>\r\n  <course-control id=\"60\" control=\"15\">\r\n    <next course-control=\"61\" />\r\n  </course-control>\r\n  <course-control id=\"61\" control=\"2\" />\r\n  <course-control id=\"62\" control=\"37\">\r\n    <next course-control=\"63\" />\r\n  </course-control>\r\n  <course-control id=\"63\" control=\"38\">\r\n    <next course-control=\"64\" />\r\n  </course-control>\r\n  <course-control id=\"64\" control=\"39\">\r\n    <next course-control=\"59\" />\r\n  </course-control>\r\n  <course-control id=\"65\" control=\"40\">\r\n    <next course-control=\"53\" />\r\n  </course-control>\r\n  <course-control id=\"67\" control=\"41\">\r\n    <next course-control=\"54\" />\r\n  </course-control>\r\n  <special-object id=\"1\" kind=\"descriptions\">\r\n    <appearance columns=\"2\" />\r\n    <location x=\"-1.00035858\" y=\"2.0887146\" />\r\n    <location x=\"5.084303\" y=\"2.0887146\" />\r\n    <courses all=\"true\" />\r\n  </special-object>\r\n  <special-object id=\"2\" kind=\"text\">\r\n    <text>$(CourseName)</text>\r\n    <font name=\"Roboto\" bold=\"true\" italic=\"false\" />\r\n    <appearance color=\"purple\" />\r\n    <location x=\"102.2344\" y=\"2.537117\" />\r\n    <location x=\"157.146332\" y=\"-20.954422\" />\r\n    <courses all=\"true\" />\r\n  </special-object>\r\n  <special-object id=\"3\" kind=\"text\">\r\n    <text>Courses close 20:00</text>\r\n    <font name=\"Roboto\" bold=\"true\" italic=\"false\" />\r\n    <appearance color=\"purple\" />\r\n    <location x=\"102.5395\" y=\"-17.9026871\" />\r\n    <location x=\"157.146332\" y=\"-26.14064\" />\r\n    <courses all=\"true\" />\r\n  </special-object>\r\n</course-scribe-event>\r\n------WebKitFormBoundaryW0wKf7e6Tkruhksr--\r\n"
    }
    handler(event, None)
